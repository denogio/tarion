#!/bin/bash
# Tarion Theme Selector

if [[ -z "${1}" ]]; then
  echo "Usage: tarion-theme-set <theme-name>"
  exit 1
fi

CURRENT_THEME_PATH="${HOME}/.config/tarion/current/theme"
NEXT_THEME_PATH="${HOME}/.config/tarion/current/next-theme"
USER_THEMES_PATH="${HOME}/.config/tarion/themes"
SYSTEM_THEMES_PATH="/usr/share/tarion/themes"

THEME_NAME="$(echo "${1}" | sed -E 's/<[^>]+>//g' | tr '[:upper:]' '[:lower:]' | tr ' ' '-')"

if [[ -d "${USER_THEMES_PATH}/${THEME_NAME}" ]]; then
  THEME_PATH="${USER_THEMES_PATH}/${THEME_NAME}"
elif [[ -d "${SYSTEM_THEMES_PATH}/${THEME_NAME}" ]]; then
  THEME_PATH="${SYSTEM_THEMES_PATH}/${THEME_NAME}"
else
  echo "Error: Theme '${THEME_NAME}' not found."
  exit 1
fi

# Setup clean next theme directory
rm -rf "${NEXT_THEME_PATH}"
mkdir -p "${NEXT_THEME_PATH}"

# Copy theme configs
cp -r "${THEME_PATH}/"* "${NEXT_THEME_PATH}/" 2>/dev/null || true

# Generate dynamic configs
# tarion-theme-set-templates # TODO: Enable when ported

# Swap theme
rm -rf "${CURRENT_THEME_PATH}"
mv "${NEXT_THEME_PATH}" "${CURRENT_THEME_PATH}"

# Store name
echo "${THEME_NAME}" > "${HOME}/.config/tarion/current/theme.name"

# Change background with theme
# tarion-theme-bg-next # TODO: Enable when ported

# Apply theme to components
if pgrep -x waybar >/dev/null; then
  # tarion-restart-waybar
  systemctl --user restart waybar
fi

# tarion-restart-swayosd
# tarion-restart-terminal
# tarion-restart-hyprctl
# tarion-restart-btop
# tarion-restart-opencode
# tarion-restart-mako

# Change app-specific themes
if command -v tarion-theme-set-gnome &>/dev/null; then
    tarion-theme-set-gnome
fi
if command -v tarion-theme-set-browser &>/dev/null; then
    tarion-theme-set-browser
fi
if command -v tarion-theme-set-vscode &>/dev/null; then
    tarion-theme-set-vscode
fi
if command -v tarion-theme-set-obsidian &>/dev/null; then
    tarion-theme-set-obsidian
fi

# Call hook on theme set
# tarion-hook theme-set "$THEME_NAME"
