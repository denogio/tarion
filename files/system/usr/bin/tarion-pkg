#!/usr/bin/env bash
# Tarion Package Manager CLI
# Wrapper for modular package management system

set -euo pipefail

# Initialize Tarion libraries
TARION_LIB_DIR="/usr/lib/tarion"
PKG_LIB_DIR="${TARION_LIB_DIR}/pkg/lib"
CORE_LIB="${PKG_LIB_DIR}/core.sh"
UI_LIB="${PKG_LIB_DIR}/ui.sh"

if [ ! -f "${CORE_LIB}" ]; then
    echo "Error: Tarion package manager core not found at ${CORE_LIB}"
    exit 1
fi

# Source core library
source "${CORE_LIB}"

# Source UI library if available (optional for non-interactive)
if [ -f "${UI_LIB}" ]; then
    source "${UI_LIB}"
fi

# Initialize backends
check_and_register_backends

# Help function
show_help() {
    cat << EOF
Tarion Package Manager (tarion-pkg)

Usage: tarion-pkg <command> [args...] [backend]

Commands:
  list [backend]          List installed packages
  search <query> [backend] Search for packages
  install <pkg...> [backend] Install packages
  uninstall <pkg...> [backend] Uninstall packages
  update [backend]        Update packages
  info <pkg> [backend]    Show package information

Options:
  --backend <name>        Force specific backend (brew, flatpak)
  -h, --help              Show this help

Examples:
  tarion-pkg list
  tarion-pkg search nvim
  tarion-pkg install neovim brew
  tarion-pkg update flatpak
EOF
}

# Helper: Run command with backend
run_backend_cmd() {
    local cmd="$1"
    local backend="$2"
    shift 2
    local args=("$@")
    
    case "${backend}" in
        brew)
            brew "${cmd}" "${args[@]}"
            ;;
        flatpak)
            case "${cmd}" in
                list) flatpak list --app ;;
                search) flatpak search "${args[@]}" ;;
                install) flatpak install "${args[@]}" ;;
                uninstall) flatpak uninstall "${args[@]}" ;;
                update) flatpak update ;;
                info) flatpak info "${args[@]}" ;;
                *) echo "Error: Unknown flatpak command ${cmd}"; return 1 ;;
            esac
            ;;
        dnf)
            sudo dnf "${cmd}" "${args[@]}"
            ;;
        *)
            echo "Error: Unknown backend ${backend}"
            return 1
            ;;
    esac
}

# Main dispatcher
main() {
    if [ $# -eq 0 ]; then
        show_help
        exit 0
    fi

    local command="$1"
    shift

    # Detect backend from last argument if present
    local backend=""
    local args=()
    
    for arg in "$@"; do
        if [[ "${arg}" == "brew" || "${arg}" == "flatpak" || "${arg}" == "dnf" ]]; then
            backend="${arg}"
        else
            args+=("${arg}")
        fi
    done
    
    # Default backend priority
    if [ -z "${backend}" ]; then
        if command -v brew &>/dev/null; then
            backend="brew"
        elif command -v flatpak &>/dev/null; then
            backend="flatpak"
        else
            backend="dnf"
        fi
    fi

    case "${command}" in
        list)
            echo "Listing packages from ${backend}..."
            run_backend_cmd list "${backend}"
            ;;
        search)
            if [ ${#args[@]} -eq 0 ]; then
                echo "Usage: tarion-pkg search <query> [backend]"
                exit 1
            fi
            echo "Searching for '${args[*]}' in ${backend}..."
            run_backend_cmd search "${backend}" "${args[@]}"
            ;;
        install)
            if [ ${#args[@]} -eq 0 ]; then
                # Interactive mode with menu selection
                echo ""
                if command -v gum &>/dev/null; then
                    gum style --foreground 212 --border double --align center --margin "1 2" "Package Management Options"
                else
                    echo "Package Management Options"
                    echo "======================"
                    echo ""
                fi

                if command -v vicinae &>/dev/null; then
                    selected=$(vicinae dmenu -p "What would you like to do?" --no-section --no-quick-look --no-metadata "Search and install package
Create new web app
Show help" 2>/dev/null)
                elif command -v gum &>/dev/null; then
                    selected=$(gum choose "Search and install package" "Create new web app" "Show help" --header "What would you like to do?")
                else
                    selected=$(echo -e "1) Search and install package\n2) Create new web app\n3) Show help" | fzf --prompt "What would you like to do? " --height 10)
                fi

                case "${selected,,}" in
                    *search*|*install*)
                        # Interactive package installation
                        if command -v gum &>/dev/null; then
                            gum style --foreground "$(get_accent)" "Enter package name or search term:"
                            search_term=$(gum input --placeholder "e.g. discord, vscode")
                        else
                            read -r "Enter package name or search term: " search_term
                        fi

                        if [ -n "${search_term}" ]; then
                            # Determine backend
                            local backend=""
                            if command -v flatpak &>/dev/null; then
                                backend="flatpak"
                            elif command -v brew &>/dev/null; then
                                backend="brew"
                            else
                                backend="dnf"
                            fi

                            # Show search results
                            if command -v gum &>/dev/null; then
                                gum style --foreground "$(highlight_info)" "Searching ${backend} for '${search_term}'..."
                            else
                                echo "Searching ${backend} for '${search_term}'..."
                            fi
                            run_backend_cmd search "${backend}" "${search_term}"

                            # Ask if user wants to install
                            if command -v gum &>/dev/null; then
                                if gum confirm --affirmative "Install a package from search results?" --default=false; then
                                    gum style --foreground "$(get_accent)" "Enter package ID to install:"
                                    pkg_id=$(gum input --placeholder "e.g. com.spotify.Client")

                                    if [ -n "${pkg_id}" ]; then
                                        if command -v gum &>/dev/null; then
                                            gum style --foreground "$(highlight_info)" "Installing ${pkg_id} via ${backend}..."
                                        else
                                            echo "Installing ${pkg_id} via ${backend}..."
                                        fi
                                        run_backend_cmd install "${backend}" "${pkg_id}"
                                    fi
                                fi
                            else
                                read -r "Enter package ID to install: " pkg_id
                                if [ -n "${pkg_id}" ]; then
                                    run_backend_cmd install "${backend}" "${pkg_id}"
                                fi
                            fi
                        fi
                        ;;
                    *create*|*web*)
                        # Launch webapp installer
                        if command -v tarion-webapp-install &>/dev/null; then
                            tarion-webapp-install
                        else
                            if command -v gum &>/dev/null; then
                                gum style --foreground 196 "âœ— tarion-webapp-install not found"
                            else
                                echo "Error: tarion-webapp-install not found"
                            fi
                            exit 1
                        fi
                        ;;
                    *help*|*show*)
                        show_help
                        exit 0
                        ;;
                    *)
                        exit 0
                        ;;
                esac
                exit 0
            fi
            echo "Installing ${args[*]} via ${backend}..."
            run_backend_cmd install "${backend}" "${args[@]}"
            ;;
        uninstall|remove)
            if [ ${#args[@]} -eq 0 ]; then
                echo "Usage: tarion-pkg uninstall <package...> [backend]"
                exit 1
            fi
            echo "Uninstalling ${args[*]} from ${backend}..."
            run_backend_cmd uninstall "${backend}" "${args[@]}"
            ;;
        update|upgrade)
            echo "Updating ${backend}..."
            run_backend_cmd update "${backend}"
            ;;
        info)
            if [ ${#args[@]} -eq 0 ]; then
                echo "Usage: tarion-pkg info <pkg> [backend]"
                exit 1
            fi
            run_backend_cmd info "${backend}" "${args[@]}"
            ;;
        -h|--help)
            show_help
            ;;
        *)
            echo "Unknown command: ${command}"
            show_help
            exit 1
            ;;
    esac
}

main "$@"
