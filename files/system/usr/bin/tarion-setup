#!/usr/bin/env bash
# Tarion first-boot setup wizard
# Runs automatically on first login using gum for beautiful UX

set -euo pipefail

# Check if setup has been run before
if [ -f "${HOME}/.config/tarion/setup-done" ]; then
    if ! gum confirm "Setup has already been completed. Re-run setup?" --default=false; then
        exit 0
    fi
fi

# Show welcome screen with ASCII art
cat /usr/share/tarion/logo.txt

gum style \
  --foreground 212 \
  --border double \
  --align center \
  --margin "1 2" \
  --padding "1 2" \
  "Welcome to Tarion - Developer-Focused Distro"

echo ""

# Create config directory
mkdir -p "${HOME}/.config/tarion"

# Step 1: Developer tools
if gum confirm "Install developer tools? (ripgrep, fd, bat, eza, starship, lazygit, zoxide, VSCode, Antigravity)" --default=true; then
    if ! command -v brew &> /dev/null; then
        gum style --foreground 196 "âš ï¸  Homebrew not found!"
        echo ""
        gum style --foreground 244 "Homebrew should be installed via blue-build."
        gum style --foreground 244 "Please ensure your Tarion image includes Homebrew."
        exit 1
    fi

    gum spin --spinner dot --title "Installing developer tools..." -- bash -c "
        brew tap ublue-os/tap 2>/dev/null || true
        brew install ripgrep fd bat eza starship lazygit zoxide
        brew install --cask ublue-os/tap/visual-studio-code-linux
        brew install --cask ublue-os/tap/antigravity-linux
    "

    gum style --foreground 46 "âœ“ Developer tools installed"

    # Configure developer tools
    gum spin --spinner dot --title "Configuring developer tools..." -- bash -c "
        # Configure zoxide
        if ! grep -q 'eval \"\$(zoxide init --cmd cd bash)\"' ~/.bashrc 2>/dev/null; then
            echo '' >> ~/.bashrc
            echo '# zoxide' >> ~/.bashrc
            echo 'eval \"\$(zoxide init --cmd cd bash)\"' >> ~/.bashrc
        fi

        # Configure starship
        if ! grep -q 'eval \"\$(starship init bash)\"' ~/.bashrc 2>/dev/null; then
            echo '' >> ~/.bashrc
            echo '# starship prompt' >> ~/.bashrc
            echo 'eval \"\$(starship init bash)\"' >> ~/.bashrc
        fi

        # Create starship config
        mkdir -p ~/.config
        cat > ~/.config/starship.toml << 'EOF'
add_newline = false
format = '\${directory}\${git_branch}\${git_status}\${character}'

[character]
success_symbol = '[âžœ](bold green)'
error_symbol = '[âžœ](bold red)'

[directory]
style = 'bold blue'

[git_branch]
style = 'bold purple'

[git_status]
style = 'bold yellow'
EOF

        # Configure bat
        mkdir -p ~/.config/bat
        cat > ~/.config/bat/config << 'EOF'
--theme=base16
--style=numbers,changes
--wrap=never
EOF

        # Configure ripgrep
        mkdir -p ~/.config
        cat > ~/.config/ripgreprc << 'EOF'
--smart-case
--follow
--hidden
--glob=!.git/*
EOF
    "
    gum style --foreground 46 "âœ“ Developer tools configured"
fi

# Step 2: Git configuration
if gum confirm "Configure Git?" --default=true; then
    git_user=$(gum input --placeholder "Your Git username" --value "${USER}")
    git_email=$(gum input --placeholder "Your Git email" --prompt "Email: ")

    git config --global user.name "${git_user}"
    git config --global user.email "${git_email}"

    gum style --foreground 46 "âœ“ Git configured as: ${git_user} <${git_email}>"
fi

# Step 3: SSH keys
if gum confirm "Generate SSH keys?" --default=false; then
    git_email=$(git config --global user.email)
    if [ -z "${git_email}" ]; then
        git_email=$(gum input --placeholder "Your email for SSH keys")
    fi

    gum spin --spinner dot --title "Generating SSH keys..." -- ssh-keygen -t ed25519 -C "${git_email}"

    gum style --foreground 46 "âœ“ SSH keys generated"
    echo ""
    gum style --foreground 220 "Public key location: ${HOME}/.ssh/id_ed25519.pub"
    echo ""
    gum style --foreground 46 "ðŸ“‹ Public key:"
    cat "${HOME}/.ssh/id_ed25519.pub"
    echo ""
fi

# Step 4: Wallpaper
if gum confirm "Set a default wallpaper?" --default=true; then
    if command -v vicinae &> /dev/null; then
        gum style --foreground 220 "ðŸ’¡ Open Vicinae (SUPER+R) and select 'Wallpaper Picker' to set a wallpaper"
    fi
fi

# Step 5: Default Theme
if gum confirm "Set default theme (Catppuccin Mocha)?" --default=true; then
    gum spin --spinner dot --title "Setting up theme..." -- bash -c "
        if command -v tarion-theme-set &> /dev/null; then
            tarion-theme-set catppuccin-mocha
        else
            echo 'tarion-theme-set not found'
        fi
    "
    gum style --foreground 46 "âœ“ Theme set to Catppuccin Mocha"
fi

# Step 6: Greeter Sync
if gum confirm "Sync Greeter theme?" --default=true; then
    gum spin --spinner dot --title "Syncing greeter..." -- bash -c "
        if command -v dms &> /dev/null; then
            echo 'Running dms greeter sync...'
            dms greeter sync || echo 'Warning: dms greeter sync failed, you might need to run it manually.'
        else
            echo 'dms command not found'
        fi
    "
    gum style --foreground 46 "âœ“ Greeter synced"
fi

# Step 5: System info
gum style \
  --foreground 212 \
  --border double \
  --align center \
  --margin "1 2" \
  --padding "1 2" \
  "Setup Complete!"

# Show quick reference
gum style --foreground 212 "Quick Start Commands:"
gum style --foreground 226 "  - just dev-info      : Show installed dev tools"
gum style --foreground 226 "  - just dev-setup     : Reconfigure dev tools"
gum style --foreground 226 "  - tarion-update          : Update Tarion system"
gum style --foreground 226 "  - just               : Show all available commands"
echo ""
gum style --foreground 212 "Keyboard Shortcuts:"
gum style --foreground 226 "  - SUPER+Space     : Open Vicinae launcher"
gum style --foreground 226 "  - SUPER+SHIFT+R   : System controls (dmenu)"
gum style --foreground 226 "  - SUPER+Enter     : Terminal (Ghostty)"
gum style --foreground 226 "  - SUPER+E         : File manager (Thunar)"
echo ""

# Mark setup as complete
touch "${HOME}/.config/tarion/setup-done"

gum style --foreground 46 --margin "1 2" "âœ“ All done! Enjoy Tarion!"
