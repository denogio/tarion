#!/usr/bin/env bash
# Tarion Menu System
# Optimized for Fedora Atomic
# User config in ~/.config/tarion/ overrides system defaults

# Helper: Menu execution
menu() {
  local prompt="${1}"
  local options="${2}"
  local extra="${3}"
  local preselect="${4}"

  local args=()
  if [[ -n "${extra}" ]]; then
    read -r -a args <<<"${extra}"
  fi

  if [[ -n "${preselect}" ]]; then
    local index
    index=$(echo -e "${options}" | grep -nxF "${preselect}" | cut -d: -f1)
    if [[ -n "${index}" ]]; then
      args+=("-c" "${index}")
    fi
  fi

  echo -e "${options}" | vicinae dmenu -p "${prompt}â€¦" "${args[@]}" --no-section --no-quick-look --no-metadata 2>/dev/null
}

# Helper: Launch terminal
terminal() {
  if command -v ghostty &>/dev/null; then
    exec ghostty
  else
    exec xdg-terminal-emulator
  fi
}

# Helper: Open in editor
open_in_editor() {
  local file="${1}"
  notify-send "Editing config file" "${file}"

  if command -v nvim &>/dev/null; then
    exec nvim "${file}"
  elif command -v code &>/dev/null; then
    exec code "${file}"
  else
    exec xdg-open "${file}"
  fi
}

# Helper: Launch Web App
launch_web() {
    tarion-launch-webapp "${1}"
}

# --- Menus ---

show_main_menu() {
  local selected
  if [[ -n "${1}" ]]; then
    selected="${1}"
  else
    # Main Dashboard
    selected=$(menu "Tarion" "ó°€»  Apps\nó°§‘  Learn\nó°œ  Tools\nó°¸Œ  Style\nî˜•  Settings\nó°”  Packages\nï€¡  Update\nîš‡  System")
  fi

  case "${selected,,}" in
    *apps*) show_apps_menu "$@" ;;
    *learn*) show_learn_menu "$@" ;;
    *tools*) show_trigger_menu "$@" ;;
    *style*) show_style_menu "$@" ;;
    *settings*) show_setup_menu "$@" ;;
    *packages*) show_pkg_menu "$@" ;;
    *update*) show_update_menu "$@" ;;
    *system*) show_system_menu "$@" ;;
    *) [[ -n "${selected}" ]] && echo "Unknown selection: ${selected}" ;;
  esac
}

show_apps_menu() {
    case $(menu "Apps" "ó°ˆ¹  Browser\nï„  Editor\nó°†˜  Terminal\nó°ƒ¬  Calculator\nï¼  Files\nó°•¾  Music") in
      *Browser*) tarion-launch-browser ;;
      *Editor*) tarion-launch-editor ;;
      *Terminal*) terminal ;;
      *Calculator*) flatpak run io.elementary.calculator 2>/dev/null || gnome-calculator ;;
      *Files*) xdg-open "${HOME}" ;;
      *Music*) flatpak run com.spotify.Client 2>/dev/null || amberol ;;
      *) show_main_menu "$@" ;;
    esac
}

show_learn_menu() {
  case $(menu "Learn" "ï„œ  Keybindings\nï…  Tarion Docs\nï™  Hyprland Wiki\nó°£‡  Fedora Docs\nó±†ƒ  Neovim Docs\nî¯Š  Bash Cheatsheet") in
    *Keybindings*) open_in_editor ~/.config/tarion/hyprland.conf ;; # TODO: Show keybinding viewer
    *Tarion*) launch_web "https://github.com/denogio/tarion" ;;
    *Hyprland*) launch_web "https://wiki.hypr.land/" ;;
    *Fedora*) launch_web "https://docs.fedoraproject.org/en-US/fedora/" ;;
    *Neovim*) launch_web "https://neovim.io/doc/" ;;
    *Bash*) launch_web "https://devhints.io/bash" ;;
    *) show_main_menu "$@" ;;
  esac
}

show_trigger_menu() {
  case $(menu "Tools" "ï€°  Screenshot\nó°•¾  Audio Control\nó°‚¯  Bluetooth\nó°œ  Color Picker") in
    *Screenshot*) tarion-screenshot ;;
    *Audio*) pavucontrol || gnome-control-center sound ;;
    *Bluetooth*) blueman-manager || gnome-control-center bluetooth ;;
    *Color*) hyprpicker -a ;;
    *) show_main_menu "$@" ;;
  esac
}

show_style_menu() {
  case $(menu "Style" "ï¿½å¸Œ  Theme Selector\nï€¾  Wallpaper (Quick)\n   ðŸ“‹ Wallpaper (Menu)...\nï™  Hyprland Config\nî©´  About Tarion") in
    *Theme*) 
        # TODO: Interactive theme selector
        notify-send "Coming soon" "Interactive theme selector"
        ;;
    *Wallpaper*Quick*)
        # Quick wallpaper actions
        case $(menu "Wallpaper" "ðŸŽ² Random\nâ­ï¸  Next\nâ—€ï¸  Previous\nâ¬†ï¸  Back to Style") in
            *Random*)
                if command -v tarion-wallpaper-switcher &>/dev/null; then
                    tarion-wallpaper-switcher random
                else
                    notify-send "Error" "tarion-wallpaper-switcher not found"
                fi
                ;;
            *Next*)
                if command -v tarion-wallpaper-switcher &>/dev/null; then
                    tarion-wallpaper-switcher next
                else
                    notify-send "Error" "tarion-wallpaper-switcher not found"
                fi
                ;;
            *Previous*)
                if command -v tarion-wallpaper-switcher &>/dev/null; then
                    tarion-wallpaper-switcher prev
                else
                    notify-send "Error" "tarion-wallpaper-switcher not found"
                fi
                ;;
            *Back*) show_style_menu "$@" ;;
            *) show_style_menu "$@" ;;
        esac
        ;;
    *Wallpaper*Menu*)
        show_wallpaper_menu "$@"
        ;;
    *Hyprland*) open_in_editor ~/.config/hypr/hyprland.conf ;;
    *About*) open_in_editor /usr/share/tarion/defaults/README.md ;;
    *) show_main_menu "$@" ;;
  esac
}

show_wallpaper_menu() {
  case $(menu "Wallpaper" "ðŸŽ² Random Wallpaper\nâ­ï¸  Next Wallpaper\nâ—€ï¸  Previous Wallpaper\nðŸŽ¨ Theme Wallpaper\nðŸ“‹ Select Wallpaper...\nðŸ”„ Refresh List\nðŸ” Sync to Greeter\nðŸ–¥ï¸  Clear All\nâ¬†ï¸  Get Current Wallpaper\nâ¬†ï¸  Back to Style") in
    *Random*)
        if command -v tarion-wallpaper-switcher &>/dev/null; then
            tarion-wallpaper-switcher random
        elif [ -f "/usr/lib/vicinae/scripts/wallpaper-switcher" ]; then
            vicinae vicinae://extensions/vicinae/scripts/wallpaper-switcher
        else
            notify-send "Error" "tarion-wallpaper-switcher not found"
        fi
        ;;
    *Next*)
        if command -v tarion-wallpaper-switcher &>/dev/null; then
            tarion-wallpaper-switcher next
        else
            notify-send "Error" "tarion-wallpaper-switcher not found"
        fi
        ;;
    *Previous*)
        if command -v tarion-wallpaper-switcher &>/dev/null; then
            tarion-wallpaper-switcher prev
        else
            notify-send "Error" "tarion-wallpaper-switcher not found"
        fi
        ;;
    *Theme*)
        if command -v tarion-wallpaper-switcher &>/dev/null; then
            tarion-wallpaper-switcher from-theme
        else
            notify-send "Error" "tarion-wallpaper-switcher not found"
        fi
        ;;
    *Select*)
        # Manual wallpaper selection
        WALLPAPER_DIR="${HOME}/Pictures/Wallpapers"
        if [ ! -d "${WALLPAPER_DIR}" ]; then
            mkdir -p "${WALLPAPER_DIR}"
            notify-send "Wallpapers directory created" "${WALLPAPER_DIR}"
        fi
        
        if command -v tarion-wallpaper-switcher &>/dev/null; then
            wallpaper=$(find "${WALLPAPER_DIR}" -type f \( -name "*.jpg" -o -name "*.png" -o -name "*.jpeg" \) | vicinae dmenu --placeholder "Select wallpaper...")
            if [ -n "${wallpaper}" ]; then
                tarion-wallpaper-switcher set "${wallpaper}"
            fi
        elif [ -f "/usr/lib/vicinae/scripts/wallpaper-switcher" ]; then
            vicinae vicinae://extensions/vicinae/scripts/wallpaper-switcher
        elif command -v waypaper &>/dev/null; then
            waypaper
        else
            nautilus "${WALLPAPER_DIR}"
        fi
        ;;
    *Refresh*)
        if command -v tarion-wallpaper-switcher &>/dev/null; then
            tarion-wallpaper-switcher list
        else
            notify-send "Error" "tarion-wallpaper-switcher not found"
        fi
        ;;
    *Sync*)
        if command -v tarion-wallpaper-switcher &>/dev/null; then
            tarion-wallpaper-switcher sync-greeter
        else
            notify-send "Error" "tarion-wallpaper-switcher not found"
        fi
        ;;
    *Clear*)
        if command -v tarion-wallpaper-switcher &>/dev/null; then
            tarion-wallpaper-switcher clear
        else
            notify-send "Error" "tarion-wallpaper-switcher not found"
        fi
        ;;
    *Get*)
        if command -v tarion-wallpaper-switcher &>/dev/null; then
            current=$(tarion-wallpaper-switcher get)
            notify-send "Current Wallpaper" "${current}"
            echo "Current wallpaper: ${current}"
        else
            notify-send "Error" "tarion-wallpaper-switcher not found"
        fi
        ;;
    *Back*) show_style_menu "$@" ;;
    *) show_wallpaper_menu "$@" ;;
  esac
}

show_setup_menu() {
  case $(menu "Settings" "î˜¸  Audio\nó°‚¯  Bluetooth\nó°€²  Power\nó°‚¯  Displays\nî˜•  All Settings") in
      *Audio*) pavucontrol ;;
      *Bluetooth*) blueman-manager ;;
      *Power*) gnome-control-center power ;;
      *Displays*) wdisplays || gnome-control-center display ;;
      *All*) gnome-control-center ;;
      *) show_main_menu "$@" ;;
    esac
}

show_pkg_menu() {
  case $(menu "Packages" "ï¿½  Install Package\nó°­Œ  Remove Package\nó°‡š  Update All\nó°”  List Installed") in
    *Install*) 
        if command -v tarion-webapp-install &>/dev/null; then
            tarion-webapp-install
        else
            tarion-launch-floating-terminal-with-presentation "tarion-pkg install"
        fi
        ;;
    *Remove*) 
        # Simple prompt for now, could be improved with multiselect
        pkg=$(gum input --placeholder "Package to remove")
        if [[ -n "${pkg}" ]]; then
            tarion-launch-floating-terminal-with-presentation "tarion-pkg remove ${pkg}"
        fi
        ;;
    *Update*) tarion-launch-floating-terminal-with-presentation "tarion-pkg update" ;;
    *List*) 
        tarion-launch-floating-terminal-with-presentation "tarion-pkg list; read -p 'Press enter to close...'" 
        ;;
    *) show_main_menu "$@" ;;
  esac
}

show_update_menu() {
  case $(menu "Update" "ó°€»  System Update\nî˜•  Config Reload\nó°€²  Firmware") in
    *System*) tarion-launch-floating-terminal-with-presentation "ujust update" ;;
    *Config*) hyprctl reload && notify-send "Config reloaded" ;;
    *Firmware*) tarion-launch-floating-terminal-with-presentation "fwupdmgr refresh && fwupdmgr update" ;;
    *) show_main_menu "$@" ;;
  esac
}

show_system_menu() {
  case $(menu "System" "ï€£  Lock\nó°”Ž  Screensaver\nï€¤  Suspend\nó°¥  Reboot\nï€‘  Shutdown\nó°—¼  Log Out") in
    *Lock*) loginctl lock-session ;;
    *Screensaver*) 
        if command -v wlogout &>/dev/null; then
            wlogout
        else
             loginctl lock-session
        fi
        ;;
    *Suspend*) systemctl suspend ;;
    *Reboot*) systemctl reboot ;;
    *Shutdown*) systemctl poweroff ;;
    *Log*) loginctl terminate-user "${USER}" ;;
    *) show_main_menu "$@" ;;
  esac
}

# Entry point
if [[ -n "${1}" ]]; then
  show_main_menu "$@"
else
  show_main_menu
fi
